# Часть 2: Введение в Model Context Protocol (MCP)

В первой части мастер-класса мы разобрали три ключевых этапа работы с инструментами: определение в виде JSON-схемы, вызов через structured output от модели и возврат результата обратно модели.

Мы также увидели основные проблемы такого подхода. Форматы фрагментированы между разными провайдерами, нет стандарта для переиспользования инструментов, приходится вручную управлять регистрацией и обнаружением, возникают проблемы с безопасностью и валидацией.

MCP решает все эти проблемы, предоставляя единый стандартизированный протокол. По сути, MCP использует те же три этапа, что мы разобрали, но добавляет унифицированный формат обмена сообщениями через JSON-RPC 2.0, автоматическое обнаружение возможностей через `tools/list` и `resources/list`, встроенную валидацию через JSON Schema и архитектуру клиент-сервер для изоляции и масштабируемости.

## Что такое MCP?

Model Context Protocol - это открытый стандартизированный интерфейс, позволяющий большим языковым моделям беспрепятственно взаимодействовать с внешними инструментами, API и источниками данных.

До появления стандартизации интеграция AI требовала написания пользовательского кода для каждой комбинации инструмента и модели, что приводило к фрагментации. MCP устраняет эти хрупкие, разовые решения, предоставляя единую архитектуру.

Основные преимущества очевидны: совместимость с различными поставщиками и платформами, консистентность и единообразное поведение во всех приложениях, переиспользуемость инструментов в разных проектах и ускорение разработки благодаря plug-and-play интерфейсам без необходимости писать интеграции с нуля.

## Архитектура MCP

MCP работает на основе клиент-серверной модели, где хост-приложение управляет подключениями к нескольким серверам.

В архитектуре участвуют четыре ключевых элемента. Хосты - это AI-приложения вроде Claude Desktop, VS Code или ваших кастомных инструментов, координирующие взаимодействие. Клиенты - соединители протокола, поддерживающие связь один-к-одному с серверами. Серверы - программы, предоставляющие возможности через стандартизированный MCP. И источники данных - локальные файлы, базы данных и удаленные сервисы.

Хост выполняет важную роль: поддерживает реестр инструментов, обрабатывает аутентификацию и запросы, форматирует ответы и управляет коммуникацией между моделями и серверами.

## Как работает MCP?

MCP использует два отдельных архитектурных слоя.

Слой данных реализует протокол JSON-RPC 2.0 для всех коммуникаций, используя стандартизированный формат сообщений для вызовов методов, ответов и уведомлений. Этот слой обрабатывает управление жизненным циклом соединений, согласование возможностей и уведомления в реальном времени.

Транспортный слой управляет каналами и аутентификацией. Для коммуникации с локальными процессами используется STDIO, а для удаленных подключений - HTTP с Server-Sent Events.

Все сообщения следуют формату JSON-RPC 2.0 со стандартизированными паттернами запрос/ответ для инициализации, обнаружения возможностей, выполнения операций и уведомлений.

## Основные концепции MCP

MCP-серверы предоставляют три фундаментальных строительных блока.

**Ресурсы** - это источники данных, предоставляющие контекстную информацию. Это могут быть файлы, базы данных, API, статический и динамический контент.

**Промпты** - переиспользуемые шаблоны, структурирующие взаимодействие. Они поддерживают подстановку переменных, обнаруживаются через `prompts/list` и представляют собой предопределенные рабочие процессы.

**Инструменты** - исполняемые функции с JSON Schema для валидации параметров. Они обнаруживаются через `tools/list` и могут выполнять произвольные операции.

Серверы также могут запрашивать у клиентов дополнительные возможности. Sampling дает доступ к генерации текста языковой моделью. Elicitation позволяет запросить ввод и подтверждение от пользователя через интерфейс клиента. Logging предоставляет структурированные сообщения для отладки и мониторинга.

## Безопасность

MCP требует явного согласия пользователя перед доступом к данным или выполнением операций. Протокол включает детализированную систему разрешений, безопасную аутентификацию через OAuth или API ключи, валидацию входных данных и комплексное логирование для аудита.

## Области применения

MCP находит применение в корпоративной интеграции данных, позволяя подключать AI к внутренним базам данных и документации.

Протокол идеально подходит для создания автономных агентов, которые могут выполнять действия в реальном мире, взаимодействовать с несколькими сервисами и принимать решения на основе актуальных данных.

MCP упрощает разработку мультимодальных приложений, интегрируя различные типы данных и функциональности в единое AI-приложение.

Протокол также обеспечивает интеграцию данных в реальном времени, предоставляя моделям доступ к актуальной информации из различных источников.

## Начало работы с MCP-серверами

Для реализации MCP-серверов существуют официальные SDK на Python, TypeScript, Java и C#/.NET.

В данном руководстве мы будем использовать FastMCP - библиотеку на основе фреймворка Starlette для создания MCP-серверов на Python. FastMCP предоставляет простой и интуитивный API, асинхронную обработку запросов, автоматическую валидацию через JSON Schema и встроенную поддержку всех MCP-примитивов.

Установка простая:

```bash
pip install fastmcp
```

Вот базовый пример сервера:

```python
from fastmcp import FastMCP

mcp = FastMCP("My First MCP Server")

@mcp.tool()
def calculate_sum(a: int, b: int) -> int:
    """Складывает два числа"""
    return a + b

@mcp.resource("config://settings")
def get_settings():
    """Возвращает конфигурацию"""
    return {"version": "1.0", "mode": "production"}

if __name__ == "__main__":
    mcp.run()
```

## Почему использовать MCP вместо простых функций?

MCP предоставляет единый интерфейс для взаимодействия с различными инструментами. Вместо написания интеграций для каждой модели отдельно, вы пишете один MCP-сервер, который работает со всеми совместимыми клиентами. Это стандартизация в чистом виде.

MCP-серверы автоматически предоставляют описание своих инструментов, ресурсов и промптов. Языковая модель может узнать, какие возможности доступны, без необходимости жестко кодировать эту информацию. Это называется обнаружением возможностей.

Благодаря JSON Schema, параметры инструментов автоматически валидируются. Это предотвращает ошибки и делает инструменты более надежными.

MCP включает встроенные механизмы безопасности - контроль доступа и изоляцию между серверами.

MCP-серверы могут работать как локально, так и удаленно. Вы можете легко масштабировать архитектуру от простого локального инструмента до распределенной системы.

Один раз написанный MCP-сервер может использоваться в разных проектах, с разными языковыми моделями и в различных хост-приложениях вроде Claude Desktop, VS Code или ваших кастомных решений.

FastMCP основан на Starlette.

## Сравнение подходов

Давайте сравним простую функцию и MCP-инструмент.

Простая функция выглядит так:

```python
def get_weather(city: str) -> str:
    return f"Погода в {city}: солнечно"
```

С ней нужно вручную интегрировать каждую модель, нет стандартизированного описания, нет автоматической валидации и сложно масштабировать.

MCP-инструмент выглядит похоже:

```python
from fastmcp import FastMCP

mcp = FastMCP("Weather Service")

@mcp.tool()
def get_weather(city: str) -> str:
    """Получает текущую погоду для указанного города"""
    return f"Погода в {city}: солнечно"
```

Но получаете автоматическое обнаружение инструмента, описание генерируется из docstring, валидация параметров через type hints, работает с любым MCP-совместимым клиентом и встроенное логирование и мониторинг.
