# Комбинирование нескольких MCP-серверов

Одна из мощных возможностей FastMCP - объединение нескольких независимых серверов в один. Это позволяет строить модульные системы, где каждый сервер отвечает за свою область, но все они доступны через единую точку входа.

## Проблема модульности

Представьте, что вы создали несколько полезных MCP-серверов для разных задач. Один умеет работать с математикой, другой обрабатывает текст, третий конвертирует документы. Каждый из них работает отлично сам по себе, но что если вам нужны все эти возможности одновременно?

Конечно, можно подключить к агенту три отдельных сервера через три разных транспорта. Но это усложняет конфигурацию и требует управления несколькими процессами. FastMCP предлагает элегантное решение через метод `import_server()`, который позволяет объединить несколько серверов в один.

## Как работает import_server()

Метод `import_server()` берет все инструменты, ресурсы и промпты из одного сервера и переносит их в другой. При этом исходные серверы остаются независимыми - их код не меняется, и они по-прежнему могут использоваться отдельно в других проектах.

В нашем примере созданы два простых сервера. Файл `math_server.py` содержит инструменты для математических операций - вычисление выражений и факториалов. Файл `text_server.py` предоставляет функции для работы с текстом - подсчет слов, реверс и преобразование в верхний регистр.

Каждый из этих серверов - полноценное приложение, которое можно запустить самостоятельно. Но в файле `server_combined.py` мы создаем главный сервер, который импортирует оба эти сервера в себя.

## Структура комбинированного сервера

Процесс объединения происходит в асинхронной функции `setup()`:

```python
async def setup():
    await mcp.import_server(math_server)
    await mcp.import_server(text_server)
```

Эта функция выполняется перед запуском сервера. Она берет объекты `mcp` из импортированных модулей и переносит все их возможности в главный сервер. После этого агент, подключившийся к комбинированному серверу, увидит все инструменты из обоих серверов плюс те, что определены непосредственно в главном сервере.

Важный момент - главный сервер может иметь и собственные инструменты. В примере мы добавляем функции для работы с документами (`convert_document` и `analyze_document`). Таким образом получается трехслойная структура: собственные инструменты главного сервера плюс импортированные из двух других.

## Практический пример использования

В файле `example_combined.py` агент получает задачу, которая требует использования инструментов из всех трех источников. Сначала нужно проанализировать документ с помощью инструмента главного сервера, затем вычислить факториал количества слов через инструмент из math_server, и наконец перевернуть название документа используя функцию из text_server.

Для агента все эти инструменты выглядят как единый набор возможностей. Он не знает и не должен знать, что они приходят из разных источников. Это и есть суть абстракции - сложная модульная структура скрыта за простым интерфейсом.

## Когда использовать этот подход

Импорт серверов особенно полезен, когда вы работаете с переиспользуемыми компонентами. Допустим, у вас есть набор базовых серверов для типовых задач - работа с файлами, математика, текст, API-запросы. Эти серверы написаны один раз и хорошо протестированы.

Для каждого нового проекта вы создаете специфичный главный сервер, который импортирует нужные базовые серверы и добавляет собственную бизнес-логику. Например, для проекта анализа финансовых отчетов вы импортируете сервер работы с документами и математический сервер, а затем добавляете специализированные инструменты для финансовых расчетов.

Такой подход позволяет строить библиотеку переиспользуемых компонентов. Каждый компонент остается простым и сфокусированным на одной задаче, но при необходимости они легко комбинируются в более сложные системы.

## Преимущества модульной архитектуры

Разделение на независимые серверы упрощает тестирование. Вы можете тестировать каждый сервер отдельно, не поднимая всю систему целиком. Это делает разработку быстрее и надежнее.

Модульность также улучшает поддерживаемость кода. Когда нужно исправить баг или добавить функцию в математический сервер, вы работаете только с одним небольшим файлом. Изменения не затрагивают другие части системы.

Наконец, такая архитектура способствует переиспользованию. Если вы создали качественный text_server для одного проекта, вы можете использовать его в десятке других без копирования кода. Все изменения и улучшения автоматически доступны везде, где этот сервер импортирован.

## Запуск примера

Убедитесь, что установлены зависимости:

```bash
uv pip install fastmcp markitdown langchain langchain-openai langchain-mcp-adapters
```

Запустите пример:

```bash
cd combined-server
python example_combined.py
```

При запуске вы увидите список всех доступных инструментов из трех источников, а затем результат работы агента, который использует их для выполнения комплексной задачи.
