# Введение в Model Context Protocol (MCP)

## Что такое MCP?

Model Context Protocol (MCP) - это открытый стандартизированный интерфейс, позволяющий большим языковым моделям (LLM) беспрепятственно взаимодействовать с внешними инструментами, API и источниками данных.

### Проблема, которую решает MCP

До появления стандартизации интеграция AI требовала написания пользовательского кода для каждой комбинации инструмента и модели, что приводило к фрагментации. MCP устраняет эти хрупкие, разовые решения, предоставляя единую архитектуру.

### Основные преимущества

- **Совместимость**: работа с различными поставщиками и платформами
- **Консистентность**: единообразное поведение во всех приложениях
- **Переиспользуемость**: инструменты можно использовать в разных проектах
- **Ускорение разработки**: plug-and-play интерфейсы без необходимости писать интеграции с нуля

## Архитектура MCP

MCP работает на основе клиент-серверной модели, где хост-приложение управляет подключениями к нескольким серверам.

### Ключевые участники

- **Хосты (Hosts)**: AI-приложения (Claude Desktop, VS Code, кастомные инструменты), координирующие взаимодействие
- **Клиенты (Clients)**: соединители протокола, поддерживающие связь один-к-одному с серверами
- **Серверы (Servers)**: программы, предоставляющие возможности через стандартизированный MCP
- **Источники данных (Data Sources)**: локальные файлы, базы данных и удаленные сервисы

### Роль MCP Host

Хост выполняет следующие функции:

- Поддерживает реестр инструментов
- Обрабатывает аутентификацию
- Обрабатывает запросы
- Форматирует ответы
- Управляет коммуникацией между моделями и серверами

## Как работает MCP?

MCP использует два отдельных архитектурных слоя:

### 1. Слой данных (Data Layer)

Реализует протокол JSON-RPC 2.0 для всех коммуникаций, используя стандартизированный формат сообщений для вызовов методов, ответов и уведомлений. Этот слой обрабатывает:

- Управление жизненным циклом соединений
- Согласование возможностей
- Уведомления в реальном времени

### 2. Транспортный слой (Transport Layer)

Управляет каналами и аутентификацией через:

- **STDIO**: для коммуникации с локальными процессами
- **HTTP с Server-Sent Events**: для удаленных подключений

### Формат сообщений

Все сообщения следуют формату JSON-RPC 2.0 со стандартизированными паттернами запрос/ответ для:

- Инициализации
- Обнаружения возможностей
- Выполнения операций
- Уведомлений

Текущая версия протокола: **2025-06-18** (используется версионирование на основе дат).

## Основные концепции MCP

### Серверные примитивы

MCP-серверы предоставляют три фундаментальных строительных блока:

#### 1. Ресурсы (Resources)

Источники данных, предоставляющие контекстную информацию:

- Файлы
- Базы данных
- API
- Статический и динамический контент

#### 2. Промпты (Prompts)

Переиспользуемые шаблоны, структурирующие взаимодействие:

- Подстановка переменных
- Обнаружение через `prompts/list`
- Предопределенные рабочие процессы

#### 3. Инструменты (Tools)

Исполняемые функции с возможностями:

- JSON Schema для валидации параметров
- Обнаружение через `tools/list`
- Выполнение произвольных операций

### Клиентские возможности

Серверы могут запрашивать у клиентов:

- **Sampling**: доступ к генерации текста языковой моделью
- **Elicitation**: запрос ввода и подтверждения от пользователя через интерфейс клиента
- **Logging**: структурированные сообщения для отладки и мониторинга

## Безопасность

MCP требует явного согласия пользователя перед доступом к данным или выполнением операций. Основные принципы:

- Детализированная система разрешений
- Безопасная аутентификация (OAuth, API ключи)
- Валидация входных данных
- Комплексное логирование для аудита

## Области применения

### Корпоративная интеграция данных

Подключение AI к внутренним базам данных и документации.

### Автономные агенты

Создание AI-агентов, которые могут:

- Выполнять действия в реальном мире
- Взаимодействовать с несколькими сервисами
- Принимать решения на основе актуальных данных

### Мультимодальные приложения

Интеграция различных типов данных и функциональности в единое AI-приложение.

### Интеграция данных в реальном времени

Предоставление моделям доступа к актуальной информации из различных источников.

## Начало работы с MCP-серверами

### Доступные SDK

Для реализации MCP-серверов существуют официальные SDK на следующих языках:

- Python
- TypeScript
- Java
- C#/.NET

### Использование FastMCP

В данном руководстве мы будем использовать **FastMCP** - библиотеку на основе фреймворка Starlette для создания MCP-серверов на Python.

FastMCP предоставляет:

- Простой и интуитивный API
- Асинхронную обработку запросов
- Автоматическую валидацию через JSON Schema
- Встроенную поддержку всех MCP-примитивов

### Установка

```bash
pip install fastmcp
```

### Базовый пример сервера

```python
from fastmcp import FastMCP

# Создание MCP-сервера
mcp = FastMCP("My First MCP Server")

# Определение инструмента
@mcp.tool()
def calculate_sum(a: int, b: int) -> int:
    """Складывает два числа"""
    return a + b

# Определение ресурса
@mcp.resource("config://settings")
def get_settings():
    """Возвращает конфигурацию"""
    return {"version": "1.0", "mode": "production"}

# Запуск сервера
if __name__ == "__main__":
    mcp.run()
```

## Почему использовать MCP вместо простых функций?

### 1. Стандартизация

MCP предоставляет единый интерфейс для взаимодействия с различными инструментами. Вместо написания интеграций для каждой модели отдельно, вы пишете один MCP-сервер, который работает со всеми совместимыми клиентами.

### 2. Обнаружение возможностей

MCP-серверы автоматически предоставляют описание своих инструментов, ресурсов и промптов. Языковая модель может узнать, какие возможности доступны, без необходимости жестко кодировать эту информацию.

### 3. Валидация параметров

Благодаря JSON Schema, параметры инструментов автоматически валидируются. Это предотвращает ошибки и делает инструменты более надежными.

### 4. Безопасность

MCP включает встроенные механизмы безопасности:

- Контроль доступа
- Изоляция между серверами

### 5. Масштабируемость

MCP-серверы могут работать как локально, так и удаленно. Вы можете легко масштабировать архитектуру от простого локального инструмента до распределенной системы.

### 6. Переиспользуемость

Один раз написанный MCP-сервер может использоваться:

- В разных проектах
- С разными языковыми моделями
- В различных хост-приложениях (Claude Desktop, VS Code, кастомные решения)

### 7. Асинхронность и производительность

FastMCP основан на Starlette, что обеспечивает асинхронную обработку запросов и высокую производительность

## Сравнение подходов

### Простые функции

```python
def get_weather(city: str) -> str:
    # Логика получения погоды
    return f"Погода в {city}: солнечно"

# Проблемы:
# - Нужно вручную интегрировать с каждой моделью
# - Нет стандартизированного описания
# - Нет автоматической валидации
# - Сложно масштабировать
```

### MCP-инструмент

```python
from fastmcp import FastMCP

mcp = FastMCP("Weather Service")

@mcp.tool()
def get_weather(city: str) -> str:
    """Получает текущую погоду для указанного города"""
    # Логика получения погоды
    return f"Погода в {city}: солнечно"

# Преимущества:
# - Автоматическое обнаружение инструмента
# - Описание генерируется из docstring
# - Валидация параметров через type hints
# - Работает с любым MCP-совместимым клиентом
# - Встроенное логирование и мониторинг
```

## Заключение

Model Context Protocol представляет собой мощный стандарт для интеграции AI с внешними инструментами и данными. Использование MCP вместо простых функций обеспечивает стандартизацию, безопасность, масштабируемость и переиспользуемость, делая разработку AI-приложений более эффективной и надежной.

FastMCP упрощает создание MCP-серверов на Python, предоставляя современный асинхронный фреймворк с минимальным количеством шаблонного кода.
